<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Prediksi Kasus DBD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* (Tampilan tetap sama persis) */
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #6a1b9a, #1e88e5); color: #fff; }
    .container { background-color: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; max-width: 1000px; margin: 50px auto; color: #000; }
    h1 { text-align: center; color: #1e88e5; }
    label { display: block; margin: 10px 0 5px; color: #333; }
    input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-bottom: 20px; border-radius: 8px; background-color: #0D47A1; color: white; border: 1px solid #0D47A1; }
    input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: #1976D2; }
    button { padding: 12px 20px; background-color: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .output, .download-buttons { display: none; margin-top: 30px; }
    .chart-container { height: 400px; position: relative; }
    canvas { width: 100% !important; height: 100% !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border: 1px solid #ddd; border-radius: 8px; }
    th { background-color: #0D47A1; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://i.postimg.cc/HncHwVKh/LOGO-SIPRE-KADER-bulat.png" alt="Logo" style="max-height: 80px;" />
      <h2 style="margin: 10px 0 0; color: #1e88e5;">SiPre-KaDer</h2>
    </div>

    <h1>Formulir Prediksi Kasus DBD 6 Bulan ke Depan</h1>
    <form id="dbdForm">
      <label for="puskesmas">Nama Puskesmas:</label>
      <input type="text" id="puskesmas" />
      <label for="penduduk">Jumlah Penduduk:</label>
      <input type="number" id="penduduk" />
      <label for="kasus3bulan">Kasus DBD 3 Bulan Terakhir:</label>
      <input type="number" id="kasus3bulan" />
      <label for="genangan">Jumlah Titik Genangan Air (RT):</label>
      <input type="number" id="genangan" />
      <label for="cakupanPSN">Cakupan PSN (%):</label>
      <input type="number" id="cakupanPSN" min="0" max="100" />
      <label for="demam">Jumlah Kasus Demam Akut 1 Bulan Terakhir:</label>
      <input type="number" id="demam" />
      <label for="edukasi">Cakupan Edukasi Lingkungan (%):</label>
      <input type="number" id="edukasi" min="0" max="100" />
      <button type="button" id="btnProses">Proses</button>
    </form>

    <div class="output" id="output">
      <h2 style="color: #000;">Hasil Prediksi</h2>
      <div id="estimasiKasus"></div>
      <p id="skorRisiko"></p>
      <p id="zonaRisiko"></p>
      <div class="chart-container">
        <canvas id="chartPrediksi"></canvas>
      </div>
    </div>

    <div class="download-buttons">
      <button id="btnPdf">Download PDF</button>
      <button id="btnExcel">Download Excel</button>
      <button id="btnGambar">Download Gambar Grafik</button>
    </div>
  </div>

  <script>
    window.onload = function () {
      document.getElementById("btnProses").addEventListener("click", prosesPrediksi);
      document.getElementById("btnPdf").addEventListener("click", downloadPDF);
      document.getElementById("btnExcel").addEventListener("click", downloadExcel);
      document.getElementById("btnGambar").addEventListener("click", downloadChartImage);
    };

    function prosesPrediksi() {
      const bulan = ["Bulan 1", "Bulan 2", "Bulan 3", "Bulan 4", "Bulan 5", "Bulan 6"];
      const kasus3bulan = Number(document.getElementById("kasus3bulan").value);
      const genangan = Number(document.getElementById("genangan").value);
      const demam = Number(document.getElementById("demam").value);
      const psn = Number(document.getElementById("cakupanPSN").value);
      const edukasi = Number(document.getElementById("edukasi").value);

      const semuaKosong = [kasus3bulan, genangan, demam, psn, edukasi].every(val => isNaN(val) || val === 0);

      let basePrediksi = semuaKosong ? 0 : (kasus3bulan * 0.6) + (genangan * 0.3) + (demam * 0.4) - (psn * 0.2) - (edukasi * 0.2);

      let prediksi = Array.from({ length: 6 }, (_, i) => Math.max(0, Math.round(basePrediksi * (1 + i * 0.05))));

      const ciBawah = prediksi.map(p => Math.max(0, p - 5));
      const ciAtas = prediksi.map(p => p + 5);

      let skor = semuaKosong ? 0 : Math.max(0, Math.round(kasus3bulan * 1.5 + genangan * 1.2 + demam * 1.3 - psn * 0.5 - edukasi * 0.5));

      let zona = skor >= 60 ? "Zona Merah (Darurat)" : skor >= 30 ? "Zona Kuning (Rentan)" : "Zona Hijau (Aman)";
      let warnaZona = skor >= 60 ? "red" : skor >= 30 ? "orange" : "green";

      document.getElementById('output').style.display = 'block';
      document.querySelector('.download-buttons').style.display = 'flex';

      const estimasiTotal = prediksi.reduce((a, b) => a + b, 0);
      let tabelEstimasi = "<table><thead><tr><th>Bulan</th><th>Prediksi Kasus</th></tr></thead><tbody>";
      prediksi.forEach((val, idx) => {
        tabelEstimasi += `<tr><td>Bulan ${idx + 1}</td><td>${val}</td></tr>`;
      });
      tabelEstimasi += "</tbody></table>";

      document.getElementById('estimasiKasus').innerHTML =
        `<p style="color:black; font-weight:bold;">Estimasi Total Kasus: ${estimasiTotal} kasus</p>
         <p style="color:black; font-weight:bold;">Estimasi per Bulan:</p>${tabelEstimasi}`;
      document.getElementById('skorRisiko').innerHTML = `<span style="color: black;">Skor Risiko: ${skor}</span>`;
      document.getElementById('zonaRisiko').innerHTML = `<span style="color: ${warnaZona}; font-weight: bold;">Status Zona: ${zona}</span>`;

      const ctx = document.getElementById('chartPrediksi').getContext('2d');
      if (window.chartInstance) window.chartInstance.destroy();
      window.chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: bulan,
          datasets: [
            { label: 'Prediksi Kasus', data: prediksi, borderColor: 'blue', fill: false },
            { label: 'CI Atas (95%)', data: ciAtas, borderColor: 'green', borderDash: [5, 5], fill: false },
            { label: 'CI Bawah (95%)', data: ciBawah, borderColor: 'red', borderDash: [5, 5], fill: false }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Prediksi Kasus DBD Selama 6 Bulan' }
          },
          scales: {
            y: { title: { display: true, text: 'Jumlah Kasus' } },
            x: { title: { display: true, text: 'Bulan' } }
          }
        }
      });

      window.prediksiData = { bulan, prediksi, ciBawah, ciAtas, skor, zona };
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Laporan Prediksi DBD", 20, 20);
      const rows = window.prediksiData.bulan.map((b, i) => [b, window.prediksiData.prediksi[i], window.prediksiData.ciBawah[i], window.prediksiData.ciAtas[i]]);
      doc.autoTable({ head: [["Bulan", "Prediksi", "CI Bawah", "CI Atas"]], body: rows, startY: 30 });
      const canvas = document.getElementById("chartPrediksi");
      const imgData = canvas.toDataURL("image/png");
      doc.addImage(imgData, "PNG", 15, doc.lastAutoTable.finalY + 10, 180, 80);
      doc.text(`Skor Risiko: ${window.prediksiData.skor}`, 20, doc.lastAutoTable.finalY + 100);
      doc.text(`Status Zona: ${window.prediksiData.zona}`, 20, doc.lastAutoTable.finalY + 110);
      doc.save("prediksi-dbd.pdf");
    }

    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const wsData = [["Bulan", "Prediksi", "CI Bawah", "CI Atas"],
        ...window.prediksiData.bulan.map((b, i) => [b, window.prediksiData.prediksi[i], window.prediksiData.ciBawah[i], window.prediksiData.ciAtas[i]])];
      wsData.push([]);
      wsData.push(["Skor Risiko", window.prediksiData.skor]);
      wsData.push(["Status Zona", window.prediksiData.zona]);
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Prediksi DBD");
      XLSX.writeFile(wb, "prediksi-dbd.xlsx");
    }

    function downloadChartImage() {
      const canvas = document.getElementById("chartPrediksi");
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "grafik-prediksi-dbd.png";
      link.click();
    }
  </script>
</body>
</html>
